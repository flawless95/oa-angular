<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE en-export SYSTEM "http://xml.evernote.com/pub/evernote-export3.dtd">
<en-export export-date="20181101T133245Z" application="Evernote" version="Evernote Mac 7.2.1 (456793)">
<note><title>part 1  Scopes</title><content><![CDATA[<!DOCTYPE en-note SYSTEM "http://xml.evernote.com/pub/enml2.dtd"><en-note><div>需要实现Scope的以下功能:</div><ol><li><div>在 template/controller/directive 下实现数据绑定</div></li><li><div>UI不同部分的数据共享</div></li><li><div>发布订阅事件</div></li><li><div>数据变化监听</div></li></ol><div>数据变化监听根据 dirty-checking mechanism. (secret sauce =_= 哈哈哈)</div><div><br /></div><div><span style="font-size: 18px; font-weight: bold;">chapter 1  [</span><span style="font-size: 18px; font-weight: bold;">Scope and dirty-checking</span><span style="font-size: 18px; font-weight: bold;">]</span></div><div><br /></div><div><span style="font-style: italic; font-weight: bold;">Watching Object Properties: $watch $digest</span></div><div>   </div><div> $watch 和 $digest 作用都是对数据变化做出反应</div><div><br /></div><div>    使用$watch创建一个watcher，通过两个函数</div><ol><li><div>watch : 插入data的时候</div></li><li><div>listener：修改data的时候</div></li></ol><div>    </div><div> $digest是会通过watch 和 listener function iterate所有在scope上的watchers</div><div><br /></div><div>简单的 Scope $watch $digest 实现</div><div style="box-sizing: border-box; padding: 8px; font-family: Monaco, Menlo, Consolas, &quot;Courier New&quot;, monospace; font-size: 12px; color: rgb(51, 51, 51); border-top-left-radius: 4px; border-top-right-radius: 4px; border-bottom-right-radius: 4px; border-bottom-left-radius: 4px; background-color: rgb(251, 250, 248); border: 1px solid rgba(0, 0, 0, 0.14902);-en-codeblock:true;"><div><div><span style="color: #569cd6; font-family: Monaco; font-size: 12px;">var</span><span style="font-family: Monaco; font-size: 12px; color: rgb(51, 51, 51);"> </span><span style="color: #9cdcfe; font-family: Monaco; font-size: 12px;">_</span><span style="font-family: Monaco; font-size: 12px; color: rgb(51, 51, 51);"> </span><span style="color: #d4d4d4; font-family: Monaco; font-size: 12px;">=</span><span style="font-family: Monaco; font-size: 12px; color: rgb(51, 51, 51);"> </span><span style="color: #dcdcaa; font-family: Monaco; font-size: 12px;">require</span><span style="color: #d4d4d4; font-family: Monaco; font-size: 12px;">(</span><span style="color: #ce9178; font-family: Monaco; font-size: 12px;">'lodash'</span><span style="color: #d4d4d4; font-family: Monaco; font-size: 12px;">);</span><span style="font-family: Monaco; font-size: 12px; color: rgb(51, 51, 51);">
</span></div><div><span style="color: #569cd6; font-family: Monaco; font-size: 12px;">function</span><span style="font-family: Monaco; font-size: 12px; color: rgb(51, 51, 51);"> </span><span style="color: #dcdcaa; font-family: Monaco; font-size: 12px;">Scope</span><span style="color: #d4d4d4; font-family: Monaco; font-size: 12px;">() {</span><span style="font-family: Monaco; font-size: 12px; color: rgb(51, 51, 51);">
</span></div><div><span style="color: #6a9955; font-family: Monaco; font-size: 12px;">// store all watchers that have been regitered</span></div><div><span style="color: #569cd6; font-family: Monaco; font-size: 12px;">this</span><span style="color: #d4d4d4; font-family: Monaco; font-size: 12px;">.</span><span style="color: #9cdcfe; font-family: Monaco; font-size: 12px;">$$watchers</span><span style="font-family: Monaco; font-size: 12px; color: rgb(51, 51, 51);"> </span><span style="color: #d4d4d4; font-family: Monaco; font-size: 12px;">=</span><span style="font-family: Monaco; font-size: 12px; color: rgb(51, 51, 51);"> </span><span style="color: #d4d4d4; font-family: Monaco; font-size: 12px;">[];</span><span style="font-family: Monaco; font-size: 12px; color: rgb(51, 51, 51);">
</span></div><div><span style="color: #d4d4d4; font-family: Monaco; font-size: 12px;">}</span></div><div><span style="color: #4ec9b0; font-family: Monaco; font-size: 12px;">Scope</span><span style="color: #d4d4d4; font-family: Monaco; font-size: 12px;">.</span><span style="color: #9cdcfe; font-family: Monaco; font-size: 12px;">prototype</span><span style="color: #d4d4d4; font-family: Monaco; font-size: 12px;">.</span><span style="color: #dcdcaa; font-family: Monaco; font-size: 12px;">$watch</span><span style="font-family: Monaco; font-size: 12px; color: rgb(51, 51, 51);"> </span><span style="color: #d4d4d4; font-family: Monaco; font-size: 12px;">=</span><span style="font-family: Monaco; font-size: 12px; color: rgb(51, 51, 51);"> </span><span style="color: #d4d4d4; font-family: Monaco; font-size: 12px;">(</span><span style="color: #9cdcfe; font-family: Monaco; font-size: 12px;">watchFn</span><span style="color: #d4d4d4; font-family: Monaco; font-size: 12px;">,</span><span style="font-family: Monaco; font-size: 12px; color: rgb(51, 51, 51);"> </span><span style="color: #9cdcfe; font-family: Monaco; font-size: 12px;">listenerFn</span><span style="color: #d4d4d4; font-family: Monaco; font-size: 12px;">)</span><span style="font-family: Monaco; font-size: 12px; color: rgb(51, 51, 51);"> </span><span style="color: #569cd6; font-family: Monaco; font-size: 12px;">=&gt;</span><span style="font-family: Monaco; font-size: 12px; color: rgb(51, 51, 51);"> </span><span style="color: #d4d4d4; font-family: Monaco; font-size: 12px;">{</span><span style="font-family: Monaco; font-size: 12px; color: rgb(51, 51, 51);">
</span></div><div><span style="color: #569cd6; font-family: Monaco; font-size: 12px;">var</span><span style="font-family: Monaco; font-size: 12px; color: rgb(51, 51, 51);"> </span><span style="color: #9cdcfe; font-family: Monaco; font-size: 12px;">watcher</span><span style="font-family: Monaco; font-size: 12px; color: rgb(51, 51, 51);"> </span><span style="color: #d4d4d4; font-family: Monaco; font-size: 12px;">=</span><span style="font-family: Monaco; font-size: 12px; color: rgb(51, 51, 51);"> </span><span style="color: #d4d4d4; font-family: Monaco; font-size: 12px;">{</span><span style="font-family: Monaco; font-size: 12px; color: rgb(51, 51, 51);">
</span></div><div><span style="color: #9cdcfe; font-family: Monaco; font-size: 12px;">watchFn</span><span style="color: #d4d4d4; font-family: Monaco; font-size: 12px;">,</span></div><div><span style="color: #9cdcfe; font-family: Monaco; font-size: 12px;">listenerFn</span></div><div><span style="color: #d4d4d4; font-family: Monaco; font-size: 12px;">};</span></div><div><span style="color: #569cd6; font-family: Monaco; font-size: 12px;">this</span><span style="color: #d4d4d4; font-family: Monaco; font-size: 12px;">.</span><span style="color: #9cdcfe; font-family: Monaco; font-size: 12px;">$$watchers</span><span style="color: #d4d4d4; font-family: Monaco; font-size: 12px;">.</span><span style="color: #dcdcaa; font-family: Monaco; font-size: 12px;">push</span><span style="color: #d4d4d4; font-family: Monaco; font-size: 12px;">(</span><span style="color: #9cdcfe; font-family: Monaco; font-size: 12px;">watcher</span><span style="color: #d4d4d4; font-family: Monaco; font-size: 12px;">);</span></div><div><span style="color: #d4d4d4; font-family: Monaco; font-size: 12px;">};</span></div><div><span style="color: #4ec9b0; font-family: Monaco; font-size: 12px;">Scope</span><span style="color: #d4d4d4; font-family: Monaco; font-size: 12px;">.</span><span style="color: #9cdcfe; font-family: Monaco; font-size: 12px;">prototype</span><span style="color: #d4d4d4; font-family: Monaco; font-size: 12px;">.</span><span style="color: #dcdcaa; font-family: Monaco; font-size: 12px;">$digest</span><span style="font-family: Monaco; font-size: 12px; color: rgb(51, 51, 51);"> </span><span style="color: #d4d4d4; font-family: Monaco; font-size: 12px;">=</span><span style="font-family: Monaco; font-size: 12px; color: rgb(51, 51, 51);"> </span><span style="color: #d4d4d4; font-family: Monaco; font-size: 12px;">()</span><span style="font-family: Monaco; font-size: 12px; color: rgb(51, 51, 51);"> </span><span style="color: #569cd6; font-family: Monaco; font-size: 12px;">=&gt;</span><span style="font-family: Monaco; font-size: 12px; color: rgb(51, 51, 51);"> </span><span style="color: #d4d4d4; font-family: Monaco; font-size: 12px;">{</span><span style="font-family: Monaco; font-size: 12px; color: rgb(51, 51, 51);">
</span></div><div><span style="color: #9cdcfe; font-family: Monaco; font-size: 12px;">_</span><span style="color: #d4d4d4; font-family: Monaco; font-size: 12px;">.</span><span style="color: #dcdcaa; font-family: Monaco; font-size: 12px;">forEach</span><span style="color: #d4d4d4; font-family: Monaco; font-size: 12px;">(</span><span style="color: #569cd6; font-family: Monaco; font-size: 12px;">this</span><span style="color: #d4d4d4; font-family: Monaco; font-size: 12px;">.</span><span style="color: #9cdcfe; font-family: Monaco; font-size: 12px;">$$watchers</span><span style="color: #d4d4d4; font-family: Monaco; font-size: 12px;">, (</span><span style="color: #9cdcfe; font-family: Monaco; font-size: 12px;">watcher</span><span style="color: #d4d4d4; font-family: Monaco; font-size: 12px;">)</span><span style="font-family: Monaco; font-size: 12px; color: rgb(51, 51, 51);"> </span><span style="color: #569cd6; font-family: Monaco; font-size: 12px;">=&gt;</span><span style="font-family: Monaco; font-size: 12px; color: rgb(51, 51, 51);"> </span><span style="color: #d4d4d4; font-family: Monaco; font-size: 12px;">{</span><span style="font-family: Monaco; font-size: 12px; color: rgb(51, 51, 51);">
</span></div><div><span style="color: #9cdcfe; font-family: Monaco; font-size: 12px;">watcher</span><span style="color: #d4d4d4; font-family: Monaco; font-size: 12px;">.</span><span style="color: #dcdcaa; font-family: Monaco; font-size: 12px;">listenerFn</span><span style="color: #d4d4d4; font-family: Monaco; font-size: 12px;">();</span></div><div><span style="color: #d4d4d4; font-family: Monaco; font-size: 12px;">});</span></div><div><span style="color: #d4d4d4; font-family: Monaco; font-size: 12px;">};</span></div><div><span style="color: #4ec9b0; font-family: Monaco; font-size: 12px;">module</span><span style="color: #d4d4d4; font-family: Monaco; font-size: 12px;">.</span><span style="color: #4ec9b0; font-family: Monaco; font-size: 12px;">exports</span><span style="font-family: Monaco; font-size: 12px; color: rgb(51, 51, 51);"> </span><span style="color: #d4d4d4; font-family: Monaco; font-size: 12px;">=</span><span style="font-family: Monaco; font-size: 12px; color: rgb(51, 51, 51);"> </span><span style="color: #9cdcfe; font-family: Monaco; font-size: 12px;">Scope</span><span style="color: #d4d4d4; font-family: Monaco; font-size: 12px;">;</span><span style="font-family: Monaco; font-size: 12px; color: rgb(51, 51, 51);">
</span></div></div></div><div><br /></div><div>但是我们只想digest执行数据变化的回调，就需要 dirty-checking</div><div><br /></div><div>摘录 一段 implement scope $digest 的代码</div><div><br /></div><div>当前一个watcher里面watch的value，在后面watcher的listener里修改了，这时候 digest 回先invoke第一个watcher并且认为 newValue === oldValue.  而我们期望的是 后续会对这种情况进行 reiterate.</div><div>但是截止到现在，这是一个会指数级增加</div><div><br /></div><div style="box-sizing: border-box; padding: 8px; font-family: Monaco, Menlo, Consolas, &quot;Courier New&quot;, monospace; font-size: 12px; color: rgb(51, 51, 51); border-top-left-radius: 4px; border-top-right-radius: 4px; border-bottom-right-radius: 4px; border-bottom-left-radius: 4px; background-color: rgb(251, 250, 248); border: 1px solid rgba(0, 0, 0, 0.14902);-en-codeblock:true;"><div><div><span style="color: #4ec9b0; font-family: Monaco; font-size: 12px;">Scope</span><span style="color: #d4d4d4; font-family: Monaco; font-size: 12px;">.</span><span style="color: #9cdcfe; font-family: Monaco; font-size: 12px;">prototype</span><span style="color: #d4d4d4; font-family: Monaco; font-size: 12px;">.</span><span style="color: #dcdcaa; font-family: Monaco; font-size: 12px;">$$digestOnce</span><span style="font-family: Monaco; font-size: 12px; color: rgb(51, 51, 51);"> </span><span style="color: #d4d4d4; font-family: Monaco; font-size: 12px;">=</span><span style="font-family: Monaco; font-size: 12px; color: rgb(51, 51, 51);"> </span><span style="color: #569cd6; font-family: Monaco; font-size: 12px;">function</span><span style="color: #d4d4d4; font-family: Monaco; font-size: 12px;">() {</span><span style="font-family: Monaco; font-size: 12px; color: rgb(51, 51, 51);">
</span></div><div><span style="color: #569cd6; font-family: Monaco; font-size: 12px;">var</span><span style="font-family: Monaco; font-size: 12px; color: rgb(51, 51, 51);"> </span><span style="color: #9cdcfe; font-family: Monaco; font-size: 12px;">self</span><span style="font-family: Monaco; font-size: 12px; color: rgb(51, 51, 51);"> </span><span style="color: #d4d4d4; font-family: Monaco; font-size: 12px;">=</span><span style="font-family: Monaco; font-size: 12px; color: rgb(51, 51, 51);"> </span><span style="color: #569cd6; font-family: Monaco; font-size: 12px;">this</span><span style="color: #d4d4d4; font-family: Monaco; font-size: 12px;">;</span><span style="font-family: Monaco; font-size: 12px; color: rgb(51, 51, 51);">
</span></div><div><span style="color: #569cd6; font-family: Monaco; font-size: 12px;">var</span><span style="font-family: Monaco; font-size: 12px; color: rgb(51, 51, 51);"> </span><span style="color: #9cdcfe; font-family: Monaco; font-size: 12px;">newValue</span><span style="color: #d4d4d4; font-family: Monaco; font-size: 12px;">,</span><span style="font-family: Monaco; font-size: 12px; color: rgb(51, 51, 51);"> </span><span style="color: #9cdcfe; font-family: Monaco; font-size: 12px;">oldValue</span><span style="color: #d4d4d4; font-family: Monaco; font-size: 12px;">,</span><span style="font-family: Monaco; font-size: 12px; color: rgb(51, 51, 51);"> </span><span style="color: #9cdcfe; font-family: Monaco; font-size: 12px;">dirty</span><span style="color: #d4d4d4; font-family: Monaco; font-size: 12px;">;</span><span style="font-family: Monaco; font-size: 12px; color: rgb(51, 51, 51);">
</span></div><div><span style="color: #9cdcfe; font-family: Monaco; font-size: 12px;">_</span><span style="color: #d4d4d4; font-family: Monaco; font-size: 12px;">.</span><span style="color: #dcdcaa; font-family: Monaco; font-size: 12px;">forEach</span><span style="color: #d4d4d4; font-family: Monaco; font-size: 12px;">(</span><span style="color: #569cd6; font-family: Monaco; font-size: 12px;">this</span><span style="color: #d4d4d4; font-family: Monaco; font-size: 12px;">.</span><span style="color: #9cdcfe; font-family: Monaco; font-size: 12px;">$$watchers</span><span style="color: #d4d4d4; font-family: Monaco; font-size: 12px;">,</span><span style="font-family: Monaco; font-size: 12px; color: rgb(51, 51, 51);"> </span><span style="color: #569cd6; font-family: Monaco; font-size: 12px;">function</span><span style="color: #d4d4d4; font-family: Monaco; font-size: 12px;">(</span><span style="color: #9cdcfe; font-family: Monaco; font-size: 12px;">watcher</span><span style="color: #d4d4d4; font-family: Monaco; font-size: 12px;">) {</span><span style="font-family: Monaco; font-size: 12px; color: rgb(51, 51, 51);">
</span></div><div><span style="color: #9cdcfe; font-family: Monaco; font-size: 12px;">newValue</span><span style="font-family: Monaco; font-size: 12px; color: rgb(51, 51, 51);"> </span><span style="color: #d4d4d4; font-family: Monaco; font-size: 12px;">=</span><span style="font-family: Monaco; font-size: 12px; color: rgb(51, 51, 51);"> </span><span style="color: #9cdcfe; font-family: Monaco; font-size: 12px;">watcher</span><span style="color: #d4d4d4; font-family: Monaco; font-size: 12px;">.</span><span style="color: #dcdcaa; font-family: Monaco; font-size: 12px;">watchFn</span><span style="color: #d4d4d4; font-family: Monaco; font-size: 12px;">(</span><span style="color: #9cdcfe; font-family: Monaco; font-size: 12px;">self</span><span style="color: #d4d4d4; font-family: Monaco; font-size: 12px;">);</span><span style="font-family: Monaco; font-size: 12px; color: rgb(51, 51, 51);">
</span></div><div><span style="color: #9cdcfe; font-family: Monaco; font-size: 12px;">oldValue</span><span style="font-family: Monaco; font-size: 12px; color: rgb(51, 51, 51);"> </span><span style="color: #d4d4d4; font-family: Monaco; font-size: 12px;">=</span><span style="font-family: Monaco; font-size: 12px; color: rgb(51, 51, 51);"> </span><span style="color: #9cdcfe; font-family: Monaco; font-size: 12px;">watcher</span><span style="color: #d4d4d4; font-family: Monaco; font-size: 12px;">.</span><span style="color: #9cdcfe; font-family: Monaco; font-size: 12px;">last</span><span style="color: #d4d4d4; font-family: Monaco; font-size: 12px;">;</span><span style="font-family: Monaco; font-size: 12px; color: rgb(51, 51, 51);">
</span></div><div><span style="color: #c586c0; font-family: Monaco; font-size: 12px;">if</span><span style="font-family: Monaco; font-size: 12px; color: rgb(51, 51, 51);"> </span><span style="color: #d4d4d4; font-family: Monaco; font-size: 12px;">(</span><span style="color: #9cdcfe; font-family: Monaco; font-size: 12px;">newValue</span><span style="font-family: Monaco; font-size: 12px; color: rgb(51, 51, 51);"> </span><span style="color: #d4d4d4; font-family: Monaco; font-size: 12px;">!==</span><span style="font-family: Monaco; font-size: 12px; color: rgb(51, 51, 51);"> </span><span style="color: #9cdcfe; font-family: Monaco; font-size: 12px;">oldValue</span><span style="color: #d4d4d4; font-family: Monaco; font-size: 12px;">) {</span><span style="font-family: Monaco; font-size: 12px; color: rgb(51, 51, 51);">
</span></div><div><span style="color: #9cdcfe; font-family: Monaco; font-size: 12px;">watcher</span><span style="color: #d4d4d4; font-family: Monaco; font-size: 12px;">.</span><span style="color: #9cdcfe; font-family: Monaco; font-size: 12px;">last</span><span style="font-family: Monaco; font-size: 12px; color: rgb(51, 51, 51);"> </span><span style="color: #d4d4d4; font-family: Monaco; font-size: 12px;">=</span><span style="font-family: Monaco; font-size: 12px; color: rgb(51, 51, 51);"> </span><span style="color: #9cdcfe; font-family: Monaco; font-size: 12px;">newValue</span><span style="color: #d4d4d4; font-family: Monaco; font-size: 12px;">;</span><span style="font-family: Monaco; font-size: 12px; color: rgb(51, 51, 51);">
</span></div><div><span style="color: #9cdcfe; font-family: Monaco; font-size: 12px;">watcher</span><span style="color: #d4d4d4; font-family: Monaco; font-size: 12px;">.</span><span style="color: #dcdcaa; font-family: Monaco; font-size: 12px;">listenerFn</span><span style="color: #d4d4d4; font-family: Monaco; font-size: 12px;">(</span><span style="color: #9cdcfe; font-family: Monaco; font-size: 12px;">newValue</span><span style="color: #d4d4d4; font-family: Monaco; font-size: 12px;">, (</span><span style="color: #9cdcfe; font-family: Monaco; font-size: 12px;">oldValue</span><span style="font-family: Monaco; font-size: 12px; color: rgb(51, 51, 51);"> </span><span style="color: #d4d4d4; font-family: Monaco; font-size: 12px;">===</span><span style="font-family: Monaco; font-size: 12px; color: rgb(51, 51, 51);"> </span><span style="color: #9cdcfe; font-family: Monaco; font-size: 12px;">initWatchVal</span><span style="font-family: Monaco; font-size: 12px; color: rgb(51, 51, 51);"> </span><span style="color: #d4d4d4; font-family: Monaco; font-size: 12px;">?</span><span style="font-family: Monaco; font-size: 12px; color: rgb(51, 51, 51);"> </span><span style="color: #9cdcfe; font-family: Monaco; font-size: 12px;">newValue</span><span style="font-family: Monaco; font-size: 12px; color: rgb(51, 51, 51);"> </span><span style="color: #d4d4d4; font-family: Monaco; font-size: 12px;">:</span><span style="font-family: Monaco; font-size: 12px; color: rgb(51, 51, 51);"> </span><span style="color: #9cdcfe; font-family: Monaco; font-size: 12px;">oldValue</span><span style="color: #d4d4d4; font-family: Monaco; font-size: 12px;">),</span><span style="font-family: Monaco; font-size: 12px; color: rgb(51, 51, 51);"> </span><span style="color: #9cdcfe; font-family: Monaco; font-size: 12px;">self</span><span style="color: #d4d4d4; font-family: Monaco; font-size: 12px;">);</span><span style="font-family: Monaco; font-size: 12px; color: rgb(51, 51, 51);">
</span></div><div><span style="color: #9cdcfe; font-family: Monaco; font-size: 12px;">dirty</span><span style="font-family: Monaco; font-size: 12px; color: rgb(51, 51, 51);"> </span><span style="color: #d4d4d4; font-family: Monaco; font-size: 12px;">=</span><span style="font-family: Monaco; font-size: 12px; color: rgb(51, 51, 51);"> </span><span style="color: #569cd6; font-family: Monaco; font-size: 12px;">true</span><span style="color: #d4d4d4; font-family: Monaco; font-size: 12px;">;</span><span style="font-family: Monaco; font-size: 12px; color: rgb(51, 51, 51);">
</span></div><div><span style="color: #d4d4d4; font-family: Monaco; font-size: 12px;">}</span></div><div><span style="color: #d4d4d4; font-family: Monaco; font-size: 12px;">});</span></div><div><span style="color: #c586c0; font-family: Monaco; font-size: 12px;">return</span><span style="font-family: Monaco; font-size: 12px; color: rgb(51, 51, 51);"> </span><span style="color: #9cdcfe; font-family: Monaco; font-size: 12px;">dirty</span><span style="color: #d4d4d4; font-family: Monaco; font-size: 12px;">;</span><span style="font-family: Monaco; font-size: 12px; color: rgb(51, 51, 51);">
</span></div><div><span style="color: #d4d4d4; font-family: Monaco; font-size: 12px;">};</span></div><div><br style="font-family: Monaco; font-size: 12px; color: rgb(51, 51, 51);" /></div><div><span style="color: #4ec9b0; font-family: Monaco; font-size: 12px;">Scope</span><span style="color: #d4d4d4; font-family: Monaco; font-size: 12px;">.</span><span style="color: #9cdcfe; font-family: Monaco; font-size: 12px;">prototype</span><span style="color: #d4d4d4; font-family: Monaco; font-size: 12px;">.</span><span style="color: #dcdcaa; font-family: Monaco; font-size: 12px;">$digest</span><span style="font-family: Monaco; font-size: 12px; color: rgb(51, 51, 51);"> </span><span style="color: #d4d4d4; font-family: Monaco; font-size: 12px;">=</span><span style="font-family: Monaco; font-size: 12px; color: rgb(51, 51, 51);"> </span><span style="color: #569cd6; font-family: Monaco; font-size: 12px;">function</span><span style="color: #d4d4d4; font-family: Monaco; font-size: 12px;">() {</span><span style="font-family: Monaco; font-size: 12px; color: rgb(51, 51, 51);">
</span></div><div><span style="color: #569cd6; font-family: Monaco; font-size: 12px;">var</span><span style="font-family: Monaco; font-size: 12px; color: rgb(51, 51, 51);"> </span><span style="color: #9cdcfe; font-family: Monaco; font-size: 12px;">dirty</span><span style="color: #d4d4d4; font-family: Monaco; font-size: 12px;">;</span><span style="font-family: Monaco; font-size: 12px; color: rgb(51, 51, 51);">
</span></div><div><span style="color: #c586c0; font-family: Monaco; font-size: 12px;">do</span><span style="font-family: Monaco; font-size: 12px; color: rgb(51, 51, 51);"> </span><span style="color: #d4d4d4; font-family: Monaco; font-size: 12px;">{</span><span style="font-family: Monaco; font-size: 12px; color: rgb(51, 51, 51);">
</span></div><div><span style="color: #9cdcfe; font-family: Monaco; font-size: 12px;">dirty</span><span style="font-family: Monaco; font-size: 12px; color: rgb(51, 51, 51);"> </span><span style="color: #d4d4d4; font-family: Monaco; font-size: 12px;">=</span><span style="font-family: Monaco; font-size: 12px; color: rgb(51, 51, 51);"> </span><span style="color: #569cd6; font-family: Monaco; font-size: 12px;">this</span><span style="color: #d4d4d4; font-family: Monaco; font-size: 12px;">.</span><span style="color: #dcdcaa; font-family: Monaco; font-size: 12px;">$$digestOnce</span><span style="color: #d4d4d4; font-family: Monaco; font-size: 12px;">();</span><span style="font-family: Monaco; font-size: 12px; color: rgb(51, 51, 51);">
</span></div><div><span style="color: #d4d4d4; font-family: Monaco; font-size: 12px;">}</span><span style="font-family: Monaco; font-size: 12px; color: rgb(51, 51, 51);"> </span><span style="color: #c586c0; font-family: Monaco; font-size: 12px;">while</span><span style="color: #d4d4d4; font-family: Monaco; font-size: 12px;">(</span><span style="color: #9cdcfe; font-family: Monaco; font-size: 12px;">dirty</span><span style="color: #d4d4d4; font-family: Monaco; font-size: 12px;">);</span><span style="font-family: Monaco; font-size: 12px; color: rgb(51, 51, 51);">
</span></div><div><span style="color: #d4d4d4; font-family: Monaco; font-size: 12px;">};</span></div></div></div><div><br /></div><div>代码写到这里，还有一种相互引用的case，在两个watcher里面互相修改监听值， 会导致死循环, 所以要对这种情况加以限制。</div><div>这种限制循环最大次数的方式叫做 TTL (Time To Live)</div><div style="box-sizing: border-box; padding: 8px; font-family: Monaco, Menlo, Consolas, &quot;Courier New&quot;, monospace; font-size: 12px; color: rgb(51, 51, 51); border-top-left-radius: 4px; border-top-right-radius: 4px; border-bottom-right-radius: 4px; border-bottom-left-radius: 4px; background-color: rgb(251, 250, 248); border: 1px solid rgba(0, 0, 0, 0.14902);-en-codeblock:true;"><div><div><span style="color: #4ec9b0; font-family: Monaco; font-size: 12px;">Scope</span><span style="color: #d4d4d4; font-family: Monaco; font-size: 12px;">.</span><span style="color: #9cdcfe; font-family: Monaco; font-size: 12px;">prototype</span><span style="color: #d4d4d4; font-family: Monaco; font-size: 12px;">.</span><span style="color: #dcdcaa; font-family: Monaco; font-size: 12px;">$digest</span><span style="font-family: Monaco; font-size: 12px; color: rgb(51, 51, 51);"> </span><span style="color: #d4d4d4; font-family: Monaco; font-size: 12px;">=</span><span style="font-family: Monaco; font-size: 12px; color: rgb(51, 51, 51);"> </span><span style="color: #569cd6; font-family: Monaco; font-size: 12px;">function</span><span style="color: #d4d4d4; font-family: Monaco; font-size: 12px;">() {</span><span style="font-family: Monaco; font-size: 12px; color: rgb(51, 51, 51);">
</span></div><div><span style="color: #569cd6; font-family: Monaco; font-size: 12px;">var</span><span style="font-family: Monaco; font-size: 12px; color: rgb(51, 51, 51);"> </span><span style="color: #9cdcfe; font-family: Monaco; font-size: 12px;">ttl</span><span style="font-family: Monaco; font-size: 12px; color: rgb(51, 51, 51);"> </span><span style="color: #d4d4d4; font-family: Monaco; font-size: 12px;">=</span><span style="font-family: Monaco; font-size: 12px; color: rgb(51, 51, 51);"> </span><span style="color: #b5cea8; font-family: Monaco; font-size: 12px;">10</span><span style="color: #d4d4d4; font-family: Monaco; font-size: 12px;">;</span><span style="font-family: Monaco; font-size: 12px; color: rgb(51, 51, 51);">
</span></div><div><span style="color: #569cd6; font-family: Monaco; font-size: 12px;">var</span><span style="font-family: Monaco; font-size: 12px; color: rgb(51, 51, 51);"> </span><span style="color: #9cdcfe; font-family: Monaco; font-size: 12px;">dirty</span><span style="color: #d4d4d4; font-family: Monaco; font-size: 12px;">;</span><span style="font-family: Monaco; font-size: 12px; color: rgb(51, 51, 51);">
</span></div><div><span style="color: #c586c0; font-family: Monaco; font-size: 12px;">do</span><span style="font-family: Monaco; font-size: 12px; color: rgb(51, 51, 51);"> </span><span style="color: #d4d4d4; font-family: Monaco; font-size: 12px;">{</span><span style="font-family: Monaco; font-size: 12px; color: rgb(51, 51, 51);">
</span></div><div><span style="color: #9cdcfe; font-family: Monaco; font-size: 12px;">dirty</span><span style="font-family: Monaco; font-size: 12px; color: rgb(51, 51, 51);"> </span><span style="color: #d4d4d4; font-family: Monaco; font-size: 12px;">=</span><span style="font-family: Monaco; font-size: 12px; color: rgb(51, 51, 51);"> </span><span style="color: #569cd6; font-family: Monaco; font-size: 12px;">this</span><span style="color: #d4d4d4; font-family: Monaco; font-size: 12px;">.</span><span style="color: #dcdcaa; font-family: Monaco; font-size: 12px;">$$digestOnce</span><span style="color: #d4d4d4; font-family: Monaco; font-size: 12px;">();</span><span style="font-family: Monaco; font-size: 12px; color: rgb(51, 51, 51);">
</span></div><div><span style="color: #c586c0; font-family: Monaco; font-size: 12px;">if</span><span style="font-family: Monaco; font-size: 12px; color: rgb(51, 51, 51);"> </span><span style="color: #d4d4d4; font-family: Monaco; font-size: 12px;">(</span><span style="color: #9cdcfe; font-family: Monaco; font-size: 12px;">dirty</span><span style="font-family: Monaco; font-size: 12px; color: rgb(51, 51, 51);"> </span><span style="color: #d4d4d4; font-family: Monaco; font-size: 12px;">&amp;&amp;</span><span style="font-family: Monaco; font-size: 12px; color: rgb(51, 51, 51);"> </span><span style="color: #d4d4d4; font-family: Monaco; font-size: 12px;">!</span><span style="color: #d4d4d4; font-family: Monaco; font-size: 12px;">(</span><span style="color: #9cdcfe; font-family: Monaco; font-size: 12px;">ttl</span><span style="color: #d4d4d4; font-family: Monaco; font-size: 12px;">--</span><span style="color: #d4d4d4; font-family: Monaco; font-size: 12px;">)){</span><span style="font-family: Monaco; font-size: 12px; color: rgb(51, 51, 51);">
</span></div><div><span style="color: #c586c0; font-family: Monaco; font-size: 12px;">throw</span><span style="font-family: Monaco; font-size: 12px; color: rgb(51, 51, 51);"> </span><span style="color: #ce9178; font-family: Monaco; font-size: 12px;">'10 digest iterations reached'</span><span style="color: #d4d4d4; font-family: Monaco; font-size: 12px;">;</span><span style="font-family: Monaco; font-size: 12px; color: rgb(51, 51, 51);">
</span></div><div><span style="color: #d4d4d4; font-family: Monaco; font-size: 12px;">}</span></div><div><span style="color: #d4d4d4; font-family: Monaco; font-size: 12px;">}</span><span style="font-family: Monaco; font-size: 12px; color: rgb(51, 51, 51);"> </span><span style="color: #c586c0; font-family: Monaco; font-size: 12px;">while</span><span style="color: #d4d4d4; font-family: Monaco; font-size: 12px;">(</span><span style="color: #9cdcfe; font-family: Monaco; font-size: 12px;">dirty</span><span style="color: #d4d4d4; font-family: Monaco; font-size: 12px;">);</span><span style="font-family: Monaco; font-size: 12px; color: rgb(51, 51, 51);">
</span></div><div><span style="color: #d4d4d4; font-family: Monaco; font-size: 12px;">};</span></div></div></div><div><br /></div><div><br /></div></en-note>]]></content><created>20181028T013631Z</created><updated>20181101T132320Z</updated><note-attributes><latitude>31.26515475592794</latitude><longitude>121.491931659163</longitude><altitude>22.13458633422852</altitude><author>blithe</author><source>desktop.mac</source><reminder-order>0</reminder-order></note-attributes></note>
</en-export>
